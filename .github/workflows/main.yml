name: Test WELCOME TO BECCO

on:
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
    # 1. Build UI
    - name: Checkout UI
      uses: actions/checkout@v4
      with:
        path: ui-repo
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install & Build
      run: |
        npm ci
        npm run build
      working-directory: ui-repo
    
    - name: Start Server
      run: |
        npm run preview > server.log 2>&1 &
        npx wait-on http://localhost:4173 --timeout 30000
      working-directory: ui-repo
    
    # 2. Get test scripts
    - name: Get Test Scripts
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/test-repo-playwright-one
        token: ${{ secrets.TEST_REPO_TOKEN }}
        path: test-repo
    
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install chromium
      working-directory: test-repo
    
    # 3. Run test
    - name: Run Test
      run: npx playwright test --reporter=html
      working-directory: test-repo
      env:
        UI_BASE_URL: http://localhost:4173
    
    # 4. Upload screenshot
    - name: Upload Screenshot
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: welcome-screenshot
        path: test-results/welcome-to-becco.png