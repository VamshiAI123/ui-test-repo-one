name: Test WELCOME TO BECCO

on:
  push:
    branches: [ test ]
  pull_request:
    branches: [ test ]
    types: [closed]
    if: github.event.pull_request.merged == true

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Build UI
    - name: Checkout UI
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install & Build
      run: |
        npm ci
        npm run build
    
    - name: Start Server
      run: |
        npm run preview &
        sleep 5
    
    # 2. Get test scripts
    - name: Get Test Scripts
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/test-repo-playwright-one
        token: ${{ secrets.TEST_REPO_TOKEN }}
    
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install chromium
    
    # 3. Run test
    - name: Run Test
      run: npx playwright test --reporter=html
      env:
        UI_BASE_URL: http://localhost:4173
    
    # 4. Upload screenshot
    - name: Upload Screenshot
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: welcome-screenshot
        path: test-results/welcome-to-becco.png