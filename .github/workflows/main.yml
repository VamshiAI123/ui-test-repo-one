name: Test WELCOME TO BECCO

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]
    if: github.event.pull_request.merged == true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # 1. Build UI
    - name: Checkout UI
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install & Build UI
      run: |
        npm ci
        npm run build
    
    - name: Start UI Server
      run: |
        # Start server in background
        npx vite preview --port 4173 --host 0.0.0.0 &
        SERVER_PID=$!
        echo "Server started with PID: $SERVER_PID"
        
        # Wait for server to be ready
        for i in {1..10}; do
          if curl -s http://localhost:4173 > /dev/null; then
            echo "✅ UI server is ready!"
            break
          fi
          echo "⏳ Waiting for server... ($i/10)"
          sleep 3
        done
    
    # 2. Get test scripts
    - name: Get Test Scripts
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/test-repo-playwright-one
        token: ${{ secrets.TEST_REPO_TOKEN }}
    
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install chromium
    
    # 3. Create test-results directory
    - name: Create test directory
      run: mkdir -p test-results
    
    # 4. Run test with UI URL
    - name: Run Test
      run: npx playwright test --reporter=html,line
      env:
        UI_BASE_URL: http://localhost:4173
    
    # 5. Upload results
    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7
    
    - name: Upload Screenshot
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: welcome-screenshot
        path: |
          test-results/
          welcome-to-becco.png
        retention-days: 7