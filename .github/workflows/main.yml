name: Test & Deploy BECCO

on:
  pull_request:
    branches: [ main ]
    types: [closed]

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
    # 1. Build UI
    - name: Checkout UI
      uses: actions/checkout@v4
      with:
        path: ui-repo
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install & Build
      run: |
        npm ci
        npm run build
      working-directory: ui-repo
    
    - name: Start Server
      run: |
        npm run preview > server.log 2>&1 &
        npx wait-on http://localhost:4173 --timeout 30000
      working-directory: ui-repo
    
    # 2. Get test scripts
    - name: Get Test Scripts
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/test-repo-playwright-one
        token: ${{ secrets.TEST_REPO_TOKEN }}
        path: test-repo
    
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install chromium
      working-directory: test-repo
    
    # 3. Run test
    - name: Run Test
      run: npx playwright test --reporter=html
      working-directory: test-repo
      env:
        UI_BASE_URL: http://localhost:4173
    
    # 4. Upload screenshot
    - name: Upload Screenshot
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: welcome-screenshot
        path: test-repo/test-results/
  
  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout UI repo
    - name: Checkout UI
      uses: actions/checkout@v4
    
    # 2. Configure AWS credentials using OIDC
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
        aws-region: us-east-1
    
    # 3. Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # 4. Install dependencies
    - name: Install dependencies
      run: npm ci
    
    # 5. Build project
    - name: Build project
      run: npm run build
    
    # 6. Get CloudFront Distribution ID and S3 Bucket from CloudFormation
    - name: Get deployment info
      run: |
        DISTID=$(aws cloudformation describe-stacks --stack-name becco-reporting-app --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistro'].OutputValue" --output text)
        S3BUCKET=$(aws cloudformation describe-stacks --stack-name becco-reporting-app --query "Stacks[0].Outputs[?OutputKey=='WebAppBucket'].OutputValue" --output text)
        echo "DISTID=$DISTID" >> $GITHUB_ENV
        echo "S3BUCKET=$S3BUCKET" >> $GITHUB_ENV
        echo "Using CloudFront Distribution: $DISTID"
        echo "Using S3 Bucket: $S3BUCKET"
    
    # 7. Remove old files from S3
    - name: Clear S3 bucket
      run: aws s3 rm s3://${{ env.S3BUCKET }} --recursive
    
    # 8. Upload new build to S3
    - name: Upload to S3
      run: aws s3 cp dist s3://${{ env.S3BUCKET }} --recursive
    
    # 9. Invalidate CloudFront cache
    - name: Invalidate CloudFront
      run: |
        INVALIDATION=$(aws cloudfront create-invalidation --distribution-id ${{ env.DISTID }} --paths "/*" --query 'Invalidation.Id' --output text)
        echo "Created invalidation: $INVALIDATION"
        
        # Wait for invalidation to complete
        while true; do
          STATUS=$(aws cloudfront get-invalidation --distribution-id ${{ env.DISTID }} --id $INVALIDATION --query 'Invalidation.Status' --output text)
          echo "Invalidation status: $STATUS"
          if [ "$STATUS" == "Completed" ]; then
            echo "CloudFront invalidation completed!"
            break
          fi
          sleep 2
        done
    
    # 10. Deployment summary
    - name: Deployment Summary
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "S3 Bucket: ${{ env.S3BUCKET }}"
        echo "CloudFront Distribution: ${{ env.DISTID }}"
        echo "Build artifacts uploaded and cache invalidated."